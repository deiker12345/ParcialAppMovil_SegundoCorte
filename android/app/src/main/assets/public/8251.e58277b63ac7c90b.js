"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8251],{8251:(G,v,l)=>{l.r(v),l.d(v,{ChatPageModule:()=>B});var p=l(2200),x=l(4341),d=l(9893),P=l(8132),f=l(467),t=l(3664),u=l(2615),I=l(8328),y=l(5035),w=l(951),c=l(3148),N=l(1985);let T=(()=>{var i;class a{constructor(e){this.firestore=e,this.CHATS_COLLECTION="chats"}createChat(e,o){var n=this;return(0,f.A)(function*(){const s=n.getChatId(e,o);return(0,c.doc)(n.firestore,`${n.CHATS_COLLECTION}/${s}`),(yield(0,c.getDocs)((0,c.collection)(n.firestore,n.CHATS_COLLECTION))).docs.find(r=>r.id===s)||(yield(0,c.addDoc)((0,c.collection)(n.firestore,n.CHATS_COLLECTION),{id:s,users:[e,o],messages:[]})),s})()}sendMessage(e,o){var n=this;return(0,f.A)(function*(){const s=(0,c.doc)(n.firestore,`${n.CHATS_COLLECTION}/${e}`);yield(0,c.addDoc)((0,c.collection)(s,"messages"),o)})()}getMessages(e){return new N.c(o=>{const n=(0,c.collection)(this.firestore,`${this.CHATS_COLLECTION}/${e}/messages`),s=(0,c.query)(n,(0,c.orderBy)("timestamp","asc"));return{unsubscribe:(0,c.onSnapshot)(s,h=>{const C=h.docs.map(r=>r.data());o.next(C)})}})}getUserChats(e){var o=this;return(0,f.A)(function*(){try{const n=(0,c.collection)(o.firestore,o.CHATS_COLLECTION),s=(0,c.query)(n,(0,c.where)("users","array-contains",e)),m=yield(0,c.getDocs)(s),h=[];for(const C of m.docs){const r=C.data(),_=(0,c.collection)(o.firestore,`${o.CHATS_COLLECTION}/${C.id}/messages`),O=(0,c.query)(_,(0,c.orderBy)("timestamp","desc")),M=yield(0,c.getDocs)(O);let b;M.empty||(b=M.docs[0].data()),h.push({id:C.id,users:r.users||[],lastMessage:b})}return h.sort((C,r)=>{const _=C.lastMessage?.timestamp?.getTime()||0;return(r.lastMessage?.timestamp?.getTime()||0)-_}),h}catch(n){return console.error("Error getting user chats:",n),[]}})()}getChatId(e,o){return[e,o].sort().join("_")}static#t=i=()=>(this.\u0275fac=function(o){return new(o||a)(u.KVO(c.Firestore))},this.\u0275prov=u.jDH({token:a,factory:a.\u0275fac,providedIn:"root"}))}return i(),a})();var j=l(2953),U=l(6429);function k(i,a){if(1&i){const g=t.RV6();t.j41(0,"ion-buttons",8)(1,"ion-button",2),t.bIt("click",function(){u.eBV(g);const o=t.XpG();return u.Njj(o.openNativeView())}),t.nrm(2,"ion-icon",9),t.k0s()()}}function E(i,a){if(1&i){const g=t.RV6();t.j41(0,"div",10),t.nrm(1,"ion-icon",11),t.j41(2,"h3"),t.EFF(3,"Vista Nativa de Chat Activa"),t.k0s(),t.j41(4,"p"),t.EFF(5,"Los chats se muestran en la interfaz nativa del dispositivo para una mejor experiencia."),t.k0s(),t.j41(6,"ion-button",12),t.bIt("click",function(){u.eBV(g);const o=t.XpG();return u.Njj(o.openNativeView())}),t.EFF(7," Abrir Lista de Chats "),t.k0s()()}}function F(i,a){1&i&&(t.j41(0,"span",21),t.EFF(1,"T\xfa: "),t.k0s())}function S(i,a){if(1&i){const g=t.RV6();t.j41(0,"ion-item",15),t.bIt("click",function(){const o=u.eBV(g).$implicit,n=t.XpG(2);return u.Njj(n.openChat(o))}),t.j41(1,"ion-avatar",1),t.nrm(2,"img",16),t.k0s(),t.j41(3,"ion-label")(4,"h2",17),t.EFF(5),t.k0s(),t.j41(6,"p",18),t.DNE(7,F,2,0,"span",19),t.EFF(8),t.k0s()(),t.j41(9,"ion-note",20),t.EFF(10),t.k0s()()}if(2&i){let g,e,o;const n=a.$implicit,s=t.XpG(2);t.R7$(2),t.Y8G("src",(null==(g=s.getOtherUserProfile(n))||null==g.photos?null:g.photos[0])||"assets/icon/default-avatar.png",t.B4B)("alt",(null==(e=s.getOtherUserProfile(n))?null:e.name)+" avatar"),t.R7$(3),t.SpI(" ",(null==(o=s.getOtherUserProfile(n))?null:o.name)||"Usuario"," "),t.R7$(),t.AVh("own-message",(null==n.lastMessage?null:n.lastMessage.senderId)===s.currentUserId),t.R7$(),t.Y8G("ngIf",(null==n.lastMessage?null:n.lastMessage.senderId)===s.currentUserId),t.R7$(),t.SpI(" ",(null==n.lastMessage?null:n.lastMessage.text)||"Sin mensajes"," "),t.R7$(2),t.SpI(" ",s.formatTimestamp((null==n.lastMessage?null:n.lastMessage.timestamp)||s.getCurrentDate())," ")}}function $(i,a){if(1&i&&(t.j41(0,"div",13),t.DNE(1,S,11,8,"ion-item",14),t.k0s()),2&i){const g=t.XpG();t.R7$(),t.Y8G("ngForOf",g.chats)}}function D(i,a){if(1&i){const g=t.RV6();t.j41(0,"div",23),t.nrm(1,"ion-icon",24),t.j41(2,"h3"),t.EFF(3,"No tienes chats a\xfan"),t.k0s(),t.j41(4,"p"),t.EFF(5,"Cuando hagas match con alguien, aparecer\xe1n aqu\xed tus conversaciones."),t.k0s(),t.j41(6,"ion-button",25),t.bIt("click",function(){u.eBV(g);const o=t.XpG(2);return u.Njj(o.goBack())}),t.EFF(7," Volver al Matching "),t.k0s()()}}function A(i,a){if(1&i&&t.DNE(0,D,8,0,"div",22),2&i){const g=t.XpG();t.Y8G("ngIf",!g.useNativeChat)}}const L=[{path:"",component:(()=>{var i;class a{constructor(e,o,n,s,m,h){this.router=e,this.platform=o,this.authService=n,this.chatService=s,this.userService=m,this.nativePluginService=h,this.chats=[],this.currentUserId="",this.userProfiles={},this.useNativeChat=!1,this.useNativeChat=this.platform.is("capacitor")&&(this.platform.is("android")||this.platform.is("ios"))}ngOnInit(){var e=this;return(0,f.A)(function*(){e.currentUserId=(yield e.authService.getCurrentUserId())||"",yield e.loadChats(),e.useNativeChat&&e.chats.length>0&&e.openNativeChatList()})()}loadChats(){var e=this;return(0,f.A)(function*(){try{e.chats=yield e.chatService.getUserChats(e.currentUserId),yield e.loadUserProfiles()}catch(o){console.error("Error loading chats:",o)}})()}loadUserProfiles(){var e=this;return(0,f.A)(function*(){const o=new Set;e.chats.forEach(n=>{n.users.forEach(s=>{s!==e.currentUserId&&o.add(s)})});for(const n of o)try{const s=yield e.userService.getUserById(n);s&&(e.userProfiles[n]=s)}catch(s){console.error(`Error loading user ${n}:`,s)}})()}getOtherUserId(e){return e.users.find(o=>o!==this.currentUserId)||""}getOtherUserProfile(e){const o=this.getOtherUserId(e);return this.userProfiles[o]||null}formatTimestamp(e){const n=(new Date).getTime()-e.getTime(),s=Math.floor(n/6e4),m=Math.floor(n/36e5),h=Math.floor(n/864e5);return s<1?"Ahora":s<60?`${s}m`:m<24?`${m}h`:`${h}d`}getCurrentDate(){return new Date}openChat(e){this.useNativeChat?this.openNativeChatView(e):console.log("Chat seleccionado:",e.id)}openNativeChatList(){var e=this;return(0,f.A)(function*(){try{const o=e.chats.map(s=>{const m=e.getOtherUserId(s),h=e.userProfiles[m];return{chatId:s.id,otherUser:{uid:m,name:h?.name||"Usuario",lastName:h?.lastName||"",photo:h?.photos?.[0]},lastMessage:{id:s.lastMessage?.id||"",senderId:s.lastMessage?.senderId||"",text:s.lastMessage?.text||"Sin mensajes",timestamp:s.lastMessage?.timestamp?.getTime().toString()||Date.now().toString(),type:"text"},unreadCount:0}}),n=yield e.nativePluginService.openChatList(e.currentUserId,o);if("chat_selected"===n.action){const s=e.chats.find(m=>m.id===n.chatId);s&&e.openNativeChatView(s)}}catch(o){console.error("Error opening native chat list:",o)}})()}openNativeChatView(e){var o=this;return(0,f.A)(function*(){try{const n=o.getOtherUserProfile(e),s={uid:o.getOtherUserId(e),name:n?.name||"Usuario",lastName:n?.lastName||"",photo:n?.photos?.[0]};o.chatService.getMessages(e.id).subscribe(h=>{const C=h.map(r=>({id:r.id||"",senderId:r.senderId,text:r.text,timestamp:r.timestamp,type:r.type||"text"}));0===C.length&&C.push({id:"empty",senderId:"",text:"No hay mensajes a\xfan",timestamp:new Date,type:"text"}),o.nativePluginService.openChatView(e.id,s,C).then(r=>{"message_sent"===r.action&&console.log("Mensaje enviado:",r.message)}).catch(r=>{console.error("Error opening native chat view:",r)})})}catch(n){console.error("Error opening native chat view:",n)}})()}openNativeView(){this.useNativeChat&&this.chats.length>0&&this.openNativeChatList()}goBack(){this.router.navigate(["/home"])}static#t=i=()=>(this.\u0275fac=function(o){return new(o||a)(t.rXU(I.Ix),t.rXU(y.OD),t.rXU(w.u),t.rXU(T),t.rXU(j.D),t.rXU(U.U))},this.\u0275cmp=t.VBU({type:a,selectors:[["app-chat"]],standalone:!1,decls:13,vars:4,consts:[["noChats",""],["slot","start"],[3,"click"],["name","arrow-back"],["slot","end",4,"ngIf"],[1,"chat-list-content"],["class","native-view-active",4,"ngIf"],["class","chat-list",4,"ngIf","ngIfElse"],["slot","end"],["name","phone-portrait-outline"],[1,"native-view-active"],["name","phone-portrait-outline",1,"native-icon"],["expand","block","fill","solid",1,"open-native-btn",3,"click"],[1,"chat-list"],["button","","class","chat-item",3,"click",4,"ngFor","ngForOf"],["button","",1,"chat-item",3,"click"],[3,"src","alt"],[1,"chat-name"],[1,"last-message"],["class","you-prefix",4,"ngIf"],["slot","end",1,"timestamp"],[1,"you-prefix"],["class","no-chats-container",4,"ngIf"],[1,"no-chats-container"],["name","chatbubbles-outline",1,"no-chats-icon"],["expand","block","fill","outline",1,"back-to-matching-btn",3,"click"]],template:function(o,n){if(1&o){const s=t.RV6();t.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1)(3,"ion-button",2),t.bIt("click",function(){return u.eBV(s),u.Njj(n.goBack())}),t.nrm(4,"ion-icon",3),t.k0s()(),t.j41(5,"ion-title"),t.EFF(6,"Chats"),t.k0s(),t.DNE(7,k,3,0,"ion-buttons",4),t.k0s()(),t.j41(8,"ion-content",5),t.DNE(9,E,8,0,"div",6)(10,$,2,1,"div",7)(11,A,1,1,"ng-template",null,0,t.C5r),t.k0s()}if(2&o){const s=t.sdS(12);t.R7$(7),t.Y8G("ngIf",n.useNativeChat),t.R7$(2),t.Y8G("ngIf",n.useNativeChat),t.R7$(),t.Y8G("ngIf",n.chats.length>0&&!n.useNativeChat)("ngIfElse",s)}},dependencies:[p.Sq,p.bT,d.mC,d.Jm,d.QW,d.W9,d.eU,d.iq,d.uz,d.he,d.JI,d.BC,d.ai],styles:[".chat-list-content[_ngcontent-%COMP%]{--background: #f8f9fa}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]{padding:0}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]{--background: white;--border-color: #e9ecef;margin:8px 16px;border-radius:12px;box-shadow:0 2px 8px #0000001a;transition:transform .2s ease,box-shadow .2s ease}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 16px #00000026}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-avatar[_ngcontent-%COMP%]{width:56px;height:56px;margin-right:16px}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{border-radius:50%;object-fit:cover}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   .chat-name[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;color:#2c3e50;margin-bottom:4px}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   .last-message[_ngcontent-%COMP%]{font-size:.9rem;color:#6c757d;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   .last-message.own-message[_ngcontent-%COMP%]{color:#495057}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   .last-message[_ngcontent-%COMP%]   .you-prefix[_ngcontent-%COMP%]{font-weight:500;color:#007bff}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   .timestamp[_ngcontent-%COMP%]{font-size:.8rem;color:#adb5bd;font-weight:500}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;padding:2rem;text-align:center}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]   .no-chats-icon[_ngcontent-%COMP%]{font-size:4rem;color:#dee2e6;margin-bottom:1.5rem}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:600;color:#495057;margin-bottom:1rem}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:1rem;color:#6c757d;line-height:1.5;margin-bottom:2rem;max-width:280px}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]   .back-to-matching-btn[_ngcontent-%COMP%]{--color: #007bff;--border-color: #007bff;font-weight:600;height:44px;border-radius:22px;min-width:200px}.native-view-active[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;padding:2rem;text-align:center}.native-view-active[_ngcontent-%COMP%]   .native-icon[_ngcontent-%COMP%]{font-size:4rem;color:#007bff;margin-bottom:1.5rem}.native-view-active[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:600;color:#2c3e50;margin-bottom:1rem}.native-view-active[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:1rem;color:#6c757d;line-height:1.5;margin-bottom:2rem;max-width:300px}.native-view-active[_ngcontent-%COMP%]   .open-native-btn[_ngcontent-%COMP%]{--background: #007bff;--color: white;font-weight:600;height:44px;border-radius:22px;min-width:200px}ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: white;--color: #2c3e50;--border-color: #e9ecef}ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]{font-weight:600;font-size:1.2rem}ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--color: #007bff}@media (max-width: 768px){.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]{margin:4px 8px}.chat-list-content[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   .last-message[_ngcontent-%COMP%]{max-width:150px}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]{padding:1rem}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.3rem}.chat-list-content[_ngcontent-%COMP%]   .no-chats-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.9rem}}"]}))}return i(),a})()}];let V=(()=>{var i;class a{static#t=i=()=>(this.\u0275fac=function(o){return new(o||a)},this.\u0275mod=t.$C({type:a}),this.\u0275inj=u.G2t({imports:[P.iI.forChild(L),P.iI]}))}return i(),a})(),B=(()=>{var i;class a{static#t=i=()=>(this.\u0275fac=function(o){return new(o||a)},this.\u0275mod=t.$C({type:a}),this.\u0275inj=u.G2t({imports:[p.MD,x.YN,d.bv,V]}))}return i(),a})()}}]);